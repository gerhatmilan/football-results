@page "/user/login/{UserID}"

@layout UserLayout

@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies

@inject IUserService UserService
@inject NavigationManager NavigationManager

@code {
    [Parameter]
    public string? UserID { get; set; }

    [CascadingParameter]
    public HttpContext? HttpContext { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        int userIDAsInt;
        if (UserID != null && int.TryParse(UserID, out userIDAsInt))
        {
            User? userInDatabase = await UserService.GetUserAsync(userIDAsInt);
            if (userInDatabase != null)
            {
                var claims = new List<Claim>
                    {
                        new Claim("UserID", userInDatabase!.ID!.ToString()),
                        new Claim(ClaimTypes.Name, userInDatabase!.Username!),
                        new Claim(ClaimTypes.Role, "User")
                    };

                var claimsIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
                var claimsPrincipal = new ClaimsPrincipal(claimsIdentity);
                await HttpContext!.SignInAsync(claimsPrincipal);

                NavigationManager!.NavigateTo("/", true);
            }
            else
            {
                NavigationManager!.NavigateTo("/error", true);
            }
        }
    }
}
