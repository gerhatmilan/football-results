@page "/matches"

@inherits MatchesBase
@inject IJSRuntime JSRuntime

<PageTitle>Matches</PageTitle>

<Calendar SelectedDateValueChanged="RefreshClientTime" @rendermode="@RenderMode.InteractiveServer" />

@if (Matches != null)
{
    @if (Matches.Any())
    @foreach (var leagueWithMatchesGroup in GetMatchesByLeague(Matches))
    {
            <LeagueCard League="leagueWithMatchesGroup.matches.ElementAt(0).League" Matches="leagueWithMatchesGroup.matches" @rendermode="@RenderMode.InteractiveServer" MatchOrderOption="@MatchOrderOption.RoundThenDateAsc" />
    }

    else
    {
        <h1>No matches on this day 😒</h1>
    }
}
else
{
    <LoadingSpinner />
}

@code {
    protected override async Task OnInitializedAsync()
    {
        SelectedDate = DateTime.Now;
        await LoadMatchesAsync();
        FilterMatchesBasedOnClientDate();

        if (Matches != null && !Matches.Any())
        {
            await LoadUpcomingMatchesAsync();
        }
    }

    protected async Task RefreshClientTime(DateTime newDate)
    {
        try
        {
            // refersh client date
            await JSRuntime.InvokeVoidAsync("getClientDate", DotNetObjectReference.Create(this), "UpdateClientDate");

            OnSelectedDateChangedInCalendar(newDate);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    [JSInvokable]
    public void UpdateClientDate(string clientDateString)
    {
        DateTime utcTime = DateTime.UtcNow;
        var clientDate = DateTime.Parse(clientDateString);
        ClientUtcDiff = clientDate - utcTime;

        // round up diff based on hour
        ClientUtcDiff = TimeSpan.FromHours((int)(Math.Round((ClientUtcDiff.Hours * 60 + ClientUtcDiff.Minutes) / 60.0)));
    }
}